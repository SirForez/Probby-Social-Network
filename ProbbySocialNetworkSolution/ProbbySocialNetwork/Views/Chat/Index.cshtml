@model ProbbySocialNetwork.Models.ViewModels.ChatViewModel

@{
    ViewBag.Title = "Index";
}

<h2>Your chat with @Model.otherUser.UserName</h2>

@using ProbbySocialNetwork.Models
<div class="container">
    <div class="theContent">
        <div class="lhsMessages">
            <h2>Chats:</h2>
            @using ProbbySocialNetwork.Models
            @foreach (ApplicationUser a in Model.usersChattingWith)
            {
                <h4>@Html.ActionLink(a.UserName.ToString(), "Index", "Chat", new { username = a.UserName }, null)</h4>
            }
            <h2>Create new chats:</h2>
            @foreach (ApplicationUser a in Model.availableChatUsers)
            {
                if (!Model.usersChattingWith.Contains(a))
                {
                    <h4>@Html.ActionLink("Chat with " + a.UserName.ToString(), "CreateChat", "Chat", new { username = a.UserName }, null)</h4>
                }
            }
        </div>
        <div class="rhsMessages">
            <!--breyta i html helper-->
            <section>
                @using (Html.BeginForm("PostMessage", "Chat", new { chatID = Model.chat.ID }, FormMethod.Post, new { id = "chatForm" }))
                {
                    <input type="hidden" name="userid" value="@Model.currentUser.Id " />
                    <input type="hidden" name="username" value="@Model.currentUser.UserName" />
                    <div class="form-horizontal">
                        <label class="sr-only" for="messageText">Text: </label>
                        <textarea class="form-control" rows="4" id="messageText" name="messageText" placeholder="Insert message..."></textarea>
                    </div>

                    @Html.ValidationSummary(false)
                }
            </section>
            <section>
                <div class="messageList" id="messageList">
                    @foreach (Message m in Model.messages)
                    {
                        <div class="message">
                            <div class="message-user-info">
                                @m.UserName
                            </div>
                            <div class="message-body">
                                @m.Text
                            </div>
                        </div>
                    }
                </div>
            </section>
        </div>
    </div>
</div>

<script>
    var url = "@Url.Action("GetMessages", "Chat", new { chatID = Model.chat.ID })";
    $('document').ready(function () {
        function refresh() {
            //NOTE: Find a better fix, you trifiling gnome.
            //Otherwise your arrogance will be your undoing.
            if ($("#messageText").focusout) {
                $.ajax({
                    type: 'GET',
                    url: url,
                    success: function (data) {
                        //this clear the messagelist
                        $('#messageList').html('');
                        //this returns the new messages
                        for (var i = 0; i < data.length; i++) {
                            $('#messageList').append("<div class='message'>" +
                                '<div class="message-user-info">' + data[i].UserName + '</div>' +
                                '<div class="message-body">' + data[i].Text + '</div>' +
                                '</div>');
                        }
                        //alert(data);
                    }
                })
            }
        }
        var t = setInterval(refresh, 500);
    });
</script>